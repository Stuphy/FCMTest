<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>FCM Push Test</title>
	<link rel="manifest" href="https://stuphy.github.io/FCMTest/manifest.json">
	<!--<script src="https://www.gstatic.com/firebasejs/4.5.2/firebase.js"></script>-->

	<script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-messaging.js"></script>
	<script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyA0pzQc6lOIiV4B0Ob3G0SkKTP1yy3TgbM",
            authDomain: "xmpp-test-7ddd8.firebaseapp.com",
            databaseURL: "https://xmpp-test-7ddd8.firebaseio.com",
            projectId: "xmpp-test-7ddd8",
            storageBucket: "xmpp-test-7ddd8.appspot.com",
            messagingSenderId: "388710369795"
        };
        firebase.initializeApp(config);
	</script>
</head>
<body>
<script>
    var messaging = firebase.messaging();
    messaging.requestPermission()
        .then(function() {
            console.log('Notification permission granted.');
            // TODO(developer): Retrieve an Instance ID token for use with FCM.
            // ...
        })
        .catch(function(err) {
            console.log('Unable to get permission to notify.', err);
        });
    var swRegistration = {};
    navigator.serviceWorker.register('./firebase-messaging-sw.js').then((registration) => swRegistration = registration);
    messaging.useServiceWorker(swRegistration);
    messaging.getToken()
        .then(function(currentToken) {
            if (currentToken) {
                sendTokenToServer(currentToken);
                updateUIForPushEnabled(currentToken);
            } else {
                // Show permission request.
                console.log('No Instance ID token available. Request permission to generate one.');
                // Show permission UI.
                updateUIForPushPermissionRequired();
                setTokenSentToServer(false);
            }
        })
        .catch(function(err) {
            console.log('An error occurred while retrieving token. ', err);
            showToken('Error retrieving Instance ID token. ', err);
            setTokenSentToServer(false);
        });
    messaging.onMessage(function(payload) {
        console.log("Message received. ", payload);
        appendMessage(payload);
    });
    var subscription = navigator.serviceWorker.ready.then((sw)=> sw.pushManager.getSubscription());
    var endPoint = subscription.then((res) => res.endpoint);
    var p256dh = subscription.then((res) => btoa(String.fromCharCode.apply(String, new Uint8Array(res.getKey('p256dh')))));
    var auth = subscription.then((res) => btoa(String.fromCharCode.apply(String, new Uint8Array(res.getKey('auth')))));
    console.log('end point', endPoint);
    console.log('p256dh public', p256dh);
    console.log('auth', auth);
</script>
</body>
</html>